<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tetrisnake</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #game {
      display: grid;
      grid-template-columns: repeat(20, 20px);
      grid-template-rows: repeat(20, 20px);
      gap: 1px;
      margin: 20px;
    }
    .cell {
      width: 20px;
      height: 20px;
      background-color: #222;
    }
    .active {
      background-color: lime;
    }
    .fixed {
      background-color: #555;
    }
    .connecting {
      background-color: gold;
    }
    #score {
      margin-top: 10px;
      font-size: 1.2em;
    }
    #timer {
      margin-top: 5px;
      font-size: 1em;
      color: #ff6666;
    }
  </style>
</head>
<body>
  <h1>Tetrisnake</h1>
  <div id="game"></div>
  <div id="score">Skóre: 0</div>
  <div id="timer"></div>

  <script>
    const gridSize = 20;
    const gameElement = document.getElementById("game");
    const timerElement = document.getElementById("timer");
    const scoreElement = document.getElementById("score");
    let score = 0;

    const directions = {
      ArrowUp: [0, -1],
      ArrowDown: [0, 1],
      ArrowLeft: [-1, 0],
      ArrowRight: [1, 0],
    };

    let cells = [];
    for (let i = 0; i < gridSize * gridSize; i++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      gameElement.appendChild(cell);
      cells.push(cell);
    }

    function getIndex(x, y) {
      return y * gridSize + x;
    }

    function drawGrid() {
      cells.forEach(c => c.className = "cell");
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          if (grid[y][x] === 1) cells[getIndex(x, y)].classList.add("fixed");
          if (grid[y][x] === 2) cells[getIndex(x, y)].classList.add("active");
        }
      }
    }

    function isInside(x, y) {
      return x >= 0 && y >= 0 && x < gridSize && y < gridSize;
    }

    function clearActive() {
      for (let y = 0; y < gridSize; y++)
        for (let x = 0; x < gridSize; x++)
          if (grid[y][x] === 2) grid[y][x] = 0;
    }

    function placeActive() {
      activeShape.forEach(([x, y]) => {
        if (isInside(x, y)) grid[y][x] = 2;
      });
    }

    function move(dx, dy) {
      const moved = activeShape.map(([x, y]) => [x + dx, y + dy]);
      if (moved.every(([x, y]) => isInside(x, y) && grid[y][x] !== 1)) {
        clearActive();
        activeShape = moved;
        placeActive();
        drawGrid();
        return true;
      } else {
        if (!timerStarted) startTimer();
        return false;
      }
    }

    function startTimer() {
      timerStarted = true;
      let countdown = 3;
      timerElement.textContent = `Ukotvení za: ${countdown}`;
      const interval = setInterval(() => {
        countdown--;
        timerElement.textContent = `Ukotvení za: ${countdown}`;
        if (countdown <= 0) {
          clearInterval(interval);
          timerElement.textContent = "Ukotveno";
          fixShape();
        }
      }, 1000);
    }

    function fixShape() {
      activeShape.forEach(([x, y]) => {
        if (isInside(x, y)) grid[y][x] = 1;
      });
      checkConnection();
      setTimeout(spawnNewShape, 3000);
    }

    function checkConnection() {
      // Hledání spojení krajů – zjednodušená logika zatím: přičti body, smaž přímku
      const visited = Array.from({ length: gridSize }, () => Array(gridSize).fill(false));
      let found = false;
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          if (grid[y][x] === 1 && !visited[y][x]) {
            const cluster = [];
            floodFill(x, y, visited, cluster);
            if (touchesTwoEdges(cluster)) {
              found = true;
              cluster.forEach(([cx, cy]) => grid[cy][cx] = 0);
              score += cluster.length;
              scoreElement.textContent = `Skóre: ${score}`;
            }
          }
        }
      }
      if (found) drawGrid();
    }

    function floodFill(x, y, visited, cluster) {
      const stack = [[x, y]];
      while (stack.length > 0) {
        const [cx, cy] = stack.pop();
        if (!isInside(cx, cy) || visited[cy][cx] || grid[cy][cx] !== 1) continue;
        visited[cy][cx] = true;
        cluster.push([cx, cy]);
        [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx, dy]) => stack.push([cx+dx, cy+dy]));
      }
    }

    function touchesTwoEdges(cluster) {
      const edges = new Set();
      cluster.forEach(([x, y]) => {
        if (x === 0) edges.add("left");
        if (x === gridSize - 1) edges.add("right");
        if (y === 0) edges.add("top");
        if (y === gridSize - 1) edges.add("bottom");
      });
      return edges.size >= 2;
    }

    function spawnNewShape() {
      timerElement.textContent = "Generování nového objektu...";
      activeShape = [
        [10, 9],
        [10, 10],
        [9, 10],
        [11, 10],
      ];
      if (activeShape.some(([x, y]) => grid[y][x] !== 0)) {
        alert("Hra skončila! Není místo pro nový objekt.");
        return;
      }
      timerStarted = false;
      placeActive();
      drawGrid();
      setTimeout(() => {
        timerElement.textContent = "";
      }, 3000);
    }

    document.addEventListener("keydown", e => {
      if (e.key in directions) move(...directions[e.key]);
    });

    let grid = Array.from({ length: gridSize }, () => Array(gridSize).fill(0));
    let activeShape = [];
    let timerStarted = false;

    spawnNewShape();
    setInterval(() => move(0, 1), 600); // automatický pohyb dolů každých 600ms
  </script>
</body>
</html>
